{% extends "accounts/base.html" %}

{% block title %}Accueil - Kallam{% endblock %}
{% block body_class %}x-theme app-page{% endblock %}

{% block content %}
<section class="x-layout">
  <aside class="left-rail">
    <div class="rail-card profile-card">
      <div class="profile-head">
        <span class="avatar-badge">{{ user.first_name|default:user.username|slice:":1"|upper }}</span>
        <div>
          <p class="profile-name">{{ user.first_name }} {{ user.last_name }}</p>
          <p class="profile-handle">{{ user.username }}</p>
        </div>
      </div>
      <div class="quick-post">
        <button type="button" class="primary rail-post-btn" data-composer-jump>Publier</button>
      </div>
    </div>

    <div class="rail-card nav-card">
      <nav class="rail-nav" aria-label="Navigation secondaire">
        <a class="active" href="{% url 'accounts:home' %}">Accueil</a>
        <a href="#">Explorer</a>
        <a href="#">Messages</a>
        <a href="#">Communautes</a>
      </nav>
      <form method="post" action="{% url 'accounts:logout' %}">
        {% csrf_token %}
        <button type="submit" class="secondary rail-logout-btn">Deconnexion</button>
      </form>
    </div>
  </aside>

  <section class="timeline" aria-label="Fil principal">
    <header class="timeline-header">
      <h1>Accueil</h1>
      <p class="timeline-sub">Bienvenue sur ton fil Kallam</p>
    </header>

    <section class="composer" id="composer">
      <form method="post" enctype="multipart/form-data" class="composer-form" data-composer-form>
        {% csrf_token %}
        <div class="composer-top">
          <span class="avatar-badge muted-avatar">{{ user.first_name|default:user.username|slice:":1"|upper }}</span>
          {{ post_form.content }}
        </div>
        <div class="composer-media-fields">
          <div class="field">
            <label for="{{ post_form.image.id_for_label }}">Image</label>
            {{ post_form.image }}
            {% if post_form.image.errors %}
              <small class="error">{{ post_form.image.errors|striptags }}</small>
            {% endif %}
          </div>
          <div class="field">
            <label for="{{ post_form.youtube_url.id_for_label }}">Lien YouTube</label>
            {{ post_form.youtube_url }}
            {% if post_form.youtube_url.errors %}
              <small class="error">{{ post_form.youtube_url.errors|striptags }}</small>
            {% endif %}
          </div>
        </div>
        {% if post_form.content.errors %}
          <small class="error">{{ post_form.content.errors|striptags }}</small>
        {% endif %}
        {% if post_form.non_field_errors %}
          <small class="error">{{ post_form.non_field_errors|striptags }}</small>
        {% endif %}
        <div class="composer-footer">
          <small class="muted">280 caracteres max</small>
          <small class="muted" data-char-count>0/280</small>
          <button class="primary" type="submit" data-publish-btn>Publier</button>
        </div>
      </form>
    </section>

    <section class="posts-grid">
      {% if posts %}
        {% for post in posts %}
          <article class="tweet-card" id="post-{{ post.id }}">
            <header class="tweet-header">
              <div>
                <p class="tweet-author">
                  {{ post.author_display_name }}
                  <span>{{ post.author_handle }}</span>
                </p>
                <p class="tweet-time">{{ post.created_at|timesince }} Â· {{ post.like_count }} likes</p>
              </div>
            </header>

            {% if post.content %}
              <p class="tweet-text">{{ post.content }}</p>
            {% endif %}

            {% if post.image %}
              <figure class="tweet-media">
                <img src="{{ post.image.url }}" alt="Image publiee par {{ post.author_display_name }}" loading="lazy">
              </figure>
            {% endif %}

            {% if post.youtube_embed_url %}
              <div class="tweet-video">
                <iframe
                  src="{{ post.youtube_embed_url }}"
                  title="Video YouTube"
                  loading="lazy"
                  referrerpolicy="strict-origin-when-cross-origin"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen>
                </iframe>
              </div>
            {% endif %}

            <div class="tweet-actions">
              <button type="button" class="action-btn reply-btn" data-reply-handle="{{ post.author_handle }}">
                Repondre
              </button>

              <form method="post" action="{% url 'accounts:post_action' post.id 'repost' %}" class="inline-form">
                {% csrf_token %}
                <input type="hidden" name="next" value="{% url 'accounts:home' %}#post-{{ post.id }}">
                <button type="submit" class="action-btn {% if post.reposted_by_me %}is-active{% endif %}">
                  Reposter {% if post.repost_count %}{{ post.repost_count }}{% endif %}
                </button>
              </form>

              <form method="post" action="{% url 'accounts:post_action' post.id 'like' %}" class="inline-form">
                {% csrf_token %}
                <input type="hidden" name="next" value="{% url 'accounts:home' %}#post-{{ post.id }}">
                <button type="submit" class="action-btn {% if post.liked_by_me %}is-active{% endif %}">
                  Aimer {% if post.like_count %}{{ post.like_count }}{% endif %}
                </button>
              </form>

              <form method="post" action="{% url 'accounts:post_action' post.id 'report' %}" class="inline-form">
                {% csrf_token %}
                <input type="hidden" name="next" value="{% url 'accounts:home' %}#post-{{ post.id }}">
                <button type="submit" class="action-btn report-btn {% if post.reported_by_me %}is-reported{% endif %}">
                  {% if post.reported_by_me %}Reporte{% else %}Reporter{% endif %}
                </button>
              </form>
            </div>
          </article>
        {% endfor %}
      {% else %}
        <article class="tweet-card empty-feed">
          <p class="tweet-text">Bienvenue sur Kallam. Publie ton premier message.</p>
        </article>
      {% endif %}
    </section>
  </section>

  <aside class="right-rail">
    <div class="rail-card stat-card">
      <p class="eyebrow">Statistiques</p>
      <ul class="stat-list">
        <li><strong>{{ user.posts.count }}</strong><span>Publications</span></li>
        <li><strong>{{ posts|length }}</strong><span>Dans le fil</span></li>
        <li><strong>100%</strong><span>Visibilite locale</span></li>
      </ul>
    </div>

    <div class="rail-card trend-card">
      <p class="eyebrow">Tendances</p>
      <ul class="trends modern">
        <li>#Kallam</li>
        <li>#Citoyens</li>
        <li>#LibreExpression</li>
        <li>#Campus</li>
      </ul>
    </div>
  </aside>
</section>
{% endblock %}
